<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Support | Golden Hub</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        :root { --gold: #ffd700; --bg: #050505; --card: #111; --gray: #888; }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg); color: white; margin: 0; padding: 0; display: flex; justify-content: center; height: 100vh; }
        
        .chat-container { width: 100%; max-width: 500px; display: flex; flex-direction: column; background: #000; border-left: 1px solid #222; border-right: 1px solid #222; }
        
        /* Header */
        .chat-header { padding: 20px; text-align: center; border-bottom: 1px solid #222; background: #111; }
        .chat-header h2 { color: var(--gold); margin: 0; font-size: 20px; text-transform: uppercase; }
        .status { font-size: 12px; color: var(--gray); margin-top: 5px; }

        /* Chat Messages Area */
        .chat-box { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; background: #050505; }
        .msg { max-width: 80%; padding: 10px 15px; border-radius: 15px; font-size: 14px; line-height: 1.4; position: relative; }
        
        .msg.user { align-self: flex-end; background: var(--gold); color: #000; border-bottom-right-radius: 2px; }
        .msg.admin { align-self: flex-start; background: #222; color: #fff; border-bottom-left-radius: 2px; }

        /* Input Area */
        .input-area { padding: 15px; display: flex; gap: 10px; background: #111; border-top: 1px solid #222; }
        input { flex: 1; background: #000; border: 1px solid #333; color: #fff; padding: 12px; border-radius: 8px; outline: none; }
        input:focus { border-color: var(--gold); }
        .send-btn { background: var(--gold); color: #000; border: none; padding: 0 20px; border-radius: 8px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div class="chat-container">
    <div class="chat-header">
        <h2>Live Support</h2>
        <div class="status">Online | 24/7 Support</div>
    </div>

    <div id="chatBox" class="chat-box">
        <p style="text-align: center; color: #444; margin-top: 20px;">Loading conversations...</p>
    </div>

    <div class="input-area">
        <input type="text" id="userMsg" placeholder="Type your message..." onkeypress="handleEnter(event)">
        <button class="send-btn" onclick="sendMessage()">SEND</button>
    </div>
</div>

<script>
    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyDz_mp5wpULG732DXhZDoVczdy369j8WBY",
        databaseURL: "https://ludo-joy-fb32d-default-rtdb.firebaseio.com",
        projectId: "ludo-joy-fb32d"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    let currentUID = "";

    // Check Login Status
    auth.onAuthStateChanged(user => {
        if (user) {
            currentUID = user.uid;
            loadChat(user.uid);
            
            // Jab user page khol le, toh uska notification (jo admin ne bheja) reset kar dein
            db.ref('notifications/' + user.uid).update({ unread: 0 });
        } else {
            // Agar login nahi hai toh login page par bhej dein
            window.location.href = "login.html";
        }
    });

    // Load Chat Messages
    function loadChat(uid) {
        db.ref('chats/' + uid).on('value', snap => {
            const box = document.getElementById('chatBox');
            box.innerHTML = "";
            
            if(!snap.exists()) {
                box.innerHTML = `<p style="text-align: center; color: #444; margin-top: 20px;">Hello! How can we help you today?</p>`;
            }

            snap.forEach(child => {
                const m = child.val();
                const cls = m.sender === 'user' ? 'user' : 'admin';
                const msgDiv = document.createElement('div');
                msgDiv.className = `msg ${cls}`;
                msgDiv.innerText = m.text;
                box.appendChild(msgDiv);
            });
            
            // Auto scroll to bottom
            box.scrollTop = box.scrollHeight;
        });
    }

    // Send Message Function
    function sendMessage() {
        const input = document.getElementById('userMsg');
        const txt = input.value.trim();
        
        if (!txt || !currentUID) return;

        // 1. Save message to 'chats' path
        db.ref('chats/' + currentUID).push({
            sender: 'user',
            text: txt,
            timestamp: Date.now()
        }).then(() => {
            // 2. TRIGGER ADMIN NOTIFICATION (Yeh zaruri hai admin ko dikhane ke liye)
            db.ref('admin_notifications/' + currentUID).update({
                unread: 1, // Admin ko red dot milega
                timestamp: Date.now()
            });

            input.value = ""; // Clear input
        });
    }

    function handleEnter(e) {
        if (e.key === 'Enter') sendMessage();
    }
</script>

</body>
</html>