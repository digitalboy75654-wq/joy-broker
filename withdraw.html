<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Withdraw USDT | Golden Hub</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --gold: #ffd700; --bg: #050505; --card: #111; --red: #ff4d4d; --gray: #888; }
        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Poppins', sans-serif; }
        body { background: var(--bg); color: white; display: flex; flex-direction: column; align-items: center; padding: 20px; min-height: 100vh; }
        .header { width: 100%; max-width: 450px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .balance-box { background: rgba(255, 215, 0, 0.1); padding: 8px 15px; border-radius: 12px; border: 1px solid var(--gold); color: var(--gold); font-weight: 800; }
        .withdraw-card { width: 100%; max-width: 450px; background: var(--card); padding: 25px; border-radius: 30px; border: 1px solid #222; }
        select, input { width: 100%; padding: 16px; border-radius: 15px; border: 1px solid #333; background: #000; color: #fff; margin-bottom: 18px; outline: none; }
        .btn-withdraw { width: 100%; padding: 18px; background: linear-gradient(135deg, #ffd700, #b8860b); color: #000; border: none; border-radius: 18px; font-weight: 800; cursor: pointer; text-transform: uppercase; }
        .history-section { width: 100%; max-width: 450px; margin-top: 20px; padding: 15px; background: #111; border-radius: 20px; border: 1px solid #333; }
        .ins-container { width: 100%; max-width: 450px; background: rgba(255, 215, 0, 0.05); border: 1px solid rgba(255, 215, 0, 0.2); border-radius: 15px; padding: 15px; margin-bottom: 20px; }
        .ins-header { color: #ffd700; font-size: 14px; font-weight: 700; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .ins-list { list-style: none; padding: 0; margin: 0; font-size: 11px; color: #cccccc; line-height: 1.5; }
        .ins-list li { margin-bottom: 8px; padding-left: 20px; position: relative; }
        .ins-list li::before { content: "âœ”"; color: #ffd700; position: absolute; left: 0; font-size: 12px; }
    </style>
</head>
<body>

    <div class="header">
        <a href="home.html" style="color:gold; text-decoration:none;">&#8592; BACK</a>
        <div class="balance-box">$<span id="userBalance">0.00</span></div>
    </div>

    <div class="ins-container">
        <div class="ins-header"><span>ðŸ“¢</span> WITHDRAWAL INSTRUCTIONS</div>
        <ul class="ins-list">
            <li>Minimum withdrawal amount is <span style="color:gold;">$10.00</span>.</li>
            <li>A fixed network fee of <span style="color:gold;">$3.00</span> will be deducted.</li>
            <li>Processing may take up to <span style="color:gold;">24 hours</span> for approval.</li>
        </ul>
    </div>

    <div class="withdraw-card">
        <div style="background:#1a1a1a; padding:10px; border-radius:10px; margin-bottom:15px; font-size:11px;">
            <p>Account: <span id="displayEmail">Loading...</span></p>
        </div>
        <label>Network</label>
        <select id="network">
            <option value="USDT (TRC20)">USDT (Tron - TRC20)</option>
            <option value="USDT (BEP20)">USDT (BSC - BEP20)</option>
            <option value="USDT (POL)">USDT (Polygon - POL)</option>
            <option value="USDT (ERC20)">USDT (Ethereum - ERC20)</option>
        </select>
        <label>Address</label>
        <input type="text" id="address" placeholder="Wallet Address">
        <label>Amount ($)</label>
        <input type="number" id="amount" placeholder="Min 10.00" oninput="calculateNet()">
        <div style="margin-bottom:20px; font-size:13px;">Receive After Fee ($3): <span id="netAmount" style="color:gold;">$0.00</span></div>
        <button class="btn-withdraw" id="subBtn" onclick="submitWithdraw()">Submit Withdrawal</button>
    </div>

    <div class="history-section">
        <h3 style="color: gold; text-align: center; font-size: 14px; margin-bottom: 15px;">ðŸ“œ Withdrawal History</h3>
        <div id="withdrawal-history-list">
            <p style="text-align:center; color:#666; font-size:12px;">Loading history...</p>
        </div>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDz_mp5wpULG732DXhZDoVczdy369j8WBY",
        databaseURL: "https://ludo-joy-fb32d-default-rtdb.firebaseio.com",
        projectId: "ludo-joy-fb32d",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    let currentBalance = 0;
    let userName = "Member";

    auth.onAuthStateChanged(user => {
        if (user) {
            document.getElementById('displayEmail').innerText = user.email;
            // Fetch User Details (Name and Balance)
            db.ref('users/' + user.uid).on('value', (s) => {
                const data = s.val() || {};
                currentBalance = parseFloat(data.wallet) || 0;
                userName = data.name || "User";
                document.getElementById('userBalance').innerText = currentBalance.toFixed(2);
            });
            fetchHistory(user.uid);
        } else { window.location.href = "index.html"; }
    });

    function calculateNet() {
        let amt = parseFloat(document.getElementById('amount').value) || 0;
        document.getElementById('netAmount').innerText = "$" + (amt > 3 ? (amt - 3).toFixed(2) : "0.00");
    }

    function submitWithdraw() {
        const user = auth.currentUser;
        const addr = document.getElementById('address').value.trim();
        const amtValue = document.getElementById('amount').value;
        const amt = parseFloat(amtValue);
        const netw = document.getElementById('network').value;
        const receiveAmt = (amt - 3).toFixed(2);

        if (!addr || !amtValue || amt < 10 || amt > currentBalance) {
            return alert("Check address, minimum $10 or balance!");
        }

        document.getElementById('subBtn').disabled = true;
        const requestRef = db.ref('withdrawRequests').push();
        
        requestRef.set({
            uid: user.uid,
            name: userName,
            email: user.email,
            walletAddress: addr,
            walletName: netw,
            network: netw,
            requestedAmount: amt,
            receiveAmount: receiveAmt,
            status: "pending",
            timestamp: Date.now(),
            date: new Date().toLocaleString()
        }).then(() => {
            db.ref('users/' + user.uid).update({ wallet: (currentBalance - amt).toFixed(2) });
            alert("Submitted Successfully!");
            document.getElementById('amount').value = "";
            document.getElementById('address').value = "";
            document.getElementById('subBtn').disabled = false;
        }).catch(e => {
            alert("Error: " + e.message);
            document.getElementById('subBtn').disabled = false;
        });
    }

    function fetchHistory(uid) {
        db.ref('withdrawRequests').on('value', (snapshot) => {
            let historyArray = [];
            snapshot.forEach(child => {
                const data = child.val();
                if (data.uid === uid) {
                    historyArray.push(data);
                }
            });

            // Sort: Newest First (Timestamp ke hisab se)
            historyArray.sort((a, b) => b.timestamp - a.timestamp);

            let html = "";
            if (historyArray.length > 0) {
                historyArray.forEach(data => {
                    let color = data.status === "pending" ? "gold" : (data.status === "rejected" ? "#ff4d4d" : "#00e676");
                    
                    html += `
                    <div style="padding:12px; border-bottom:1px solid #222; margin-bottom:5px;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span style="font-weight:bold; font-size:15px; color:#fff;">$${parseFloat(data.requestedAmount).toFixed(2)}</span>
                            <span style="color:${color}; font-size:11px; font-weight:bold;">${data.status.toUpperCase()}</span>
                        </div>
                        <div style="display:flex; justify-content:space-between; margin-top:5px; color:#888; font-size:10px;">
                            <span>ðŸ“… ${data.date || new Date(data.timestamp).toLocaleString()}</span>
                            <span>${data.walletName || 'USDT'}</span>
                        </div>
                    </div>`;
                });
                document.getElementById('withdrawal-history-list').innerHTML = html;
            } else {
                document.getElementById('withdrawal-history-list').innerHTML = "<p style='text-align:center; color:#666; font-size:12px;'>No history found.</p>";
            }
        });
    }
</script>
</body>
</html>
